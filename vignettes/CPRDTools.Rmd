---
title: "CPRDTools: a CPRD data wrangling toolkit"
output: pdf_document

bibliography: CPRDTools_ref.bib
abstract: The analysis of large scale data, and moreover the analysis of large scale electronic health records data is become more commonplace. The ease and ability of modern data generation and capture means there is the potential across almost all industries to capture more data now, than ever before and that equates to large data resources, with CPRD no exception. These large data resources, as attractive and appealing as they may be to researchers, pose a significant problem - how to manage all that data? CPRDTools is a collection of wrapper R functions intended to simplify the loading, extraction and management of Clinical Practice Research Datalink (CPRD) GOLD specific and associated electgronic health records data. Allowing for the loading of CPRD and non-CPRD data into a SQLite based database, providing an efficient, secure and updatable repository for the data, keeing the origional source files intact. Through data queries, user-defined data are drawn allowing for subsetting, joining and filtering in a signle step, creating alaysis ready data.
    
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE,comment = "#>")
```

# Introduction

The CPRD is one of the largest longitudinal medical records databases in the world, supported by the National Institute of Health (NIHR) and the Medicines and Healthcare products Regulatory Agency (MHRA). It was first established in 1987 as the Value Added Medical Products (VAMP) dataset, this grew into the General Practice Research Database (GPRD) in 1993, before its final transition into CPRD in 2012 [@Herrett2015].

PRD GOLD data are comprised of ten separate datasets: patient, practice, staff, consultation, clinical, additional clinical details, referral, immunisation, test and therapy [@Padmanabhan2017]. These datasets contain their specific data and are linkable through a unique linkage key field, where key does not imply importance but a unique variable contained in two datasets allowing them to be joined, such as the CPRD-assigned and anonymised unique patient identifier `patid`.

Due to the size of CPRD, data extracted for research are spread over multiple text (`.txt`) files within each dataset to enable file transfer. This means that for CPRD clinical data, for instance, a researcher may receive their requested clinical data broken up over 25 individual text files. This is done to aid with file completeness and reduce turn-around times if errors are found. If an error occurred during the transfer of data between the data owner and the researcher or in the extraction of the requested data by the data owner, the error can potentially be limited to only select files, requiring only their replacement with the corrected/error-free versions. 

Often these text files are additionally zipped, or compressed, requiring that these files first be uncompressed or unzipped. These multiple files from each dataset (clinical, referral etc.) then need to be grouped together and amalgamated into a single `table`. Tables are a collection of data of the same shape, from the same dataset. In CPRD, each separate dataset (patient, practice, clinical etc.) forms a table. These tables are then stored in the SQLite database.

SQLite is an opensource, SQL based database engine [@sqlite]. The use of a SQLite database provides an efficient storage solution, allowing for the loading, updating and maintenance of the database, all while retaining the original *raw* data files unaltered. An SQlite database permits for rapid data extraction through the use of data queries, drawing the required data from the database, allowing filtering, sub-setting, limiting and the joining of data in a single execution step.   

This document aims to provide a simple and introductory overview of `CPRDTools` and its application to arbitrary (fictional) data. This data though are provided in the manner in which many CPRD data extract are received, where data are spread over multiple files and often located in sub-folders.

`CPRDTools` are loaded using:
```{r, message=FALSE}
library(devtools)
install_github("JamesCFSchmidt/CPRDTools")
library(CPRDTools)
```

# CPRDTools overview

The functions within 'CPRDTools' broadly fall into three groups, categorised by their general application area: (1) - loading, (2) - maintenance and other tasks and (3) - extraction. **Loading** encompasses all functions used in the reading, converting and writing of data into the database including a function used to list all available files and all available CPRD files in a specified location, functions used in database maintenance, query speed improvements and date conversion functions fall under **maintenance and other tasks**, and finally, functions used to, and in the process of, drawing and retrieving data from the database fall within **extraction**.

## The data

```{r}
DB.path="/rfs/LRWE_Proj59/jcfs2/Test"
FILE.path = "/rfs/LRWE_Proj59/jcfs2/Test"
```

## Loading
Before loading any data into the database, it is best practice to understand the layout of the *raw* data. This can be achieved by either navigating to the location where the data are stored or by employing the `list_files` and `list_cprd` functions. 
The `list_files` function provides a list of all files of a specified type in a specified location. To view all text (`.txt`) files in the data location
```{r}
list_files(file_location = FILE.path,
           file_type = ".txt")
```
To view all compressed/*zipped* (`.zip`) files in the data location
```{r}
list_files(file_location = FILE.path,
           file_type = ".zip")
```           
And to view all files in the data location, excluding files in sub-folders
```{r}
list_files(file_location = FILE.path,
           file_type = "all")
```

From the above it can be seen that there are six zipped text files (`.zip`), one excel file (`.xlsx`), one standard text file (`.txt`) and a folder, `patient`.
In order to view CPRD GOLD specific files, corresponding to names CPRD GOLD datasets (*patient, practice, staff, consultation, clinical, additional clinical details, referral, immunisation, test and therapy*), the `list_cprd` function is used. This function provides the core functionality to the loading of CPRD GOLD data, generating a list of CPRD GOLD specific files in the specified location.
```{r}
list_cprd(file_location = FILE.path,
          folder = F, 
          zip = T)
```
Here the folders input is defined as `r FALSE`, showing only zipped data contained in the data location specified. When the folder input is `r TRUE`, the available data found in the `patient` folder is displayed.
```{r}
list_cprd(file_location = FILE.path,
          folder = T, 
          zip = T)
```
In the `$table` output, the `list_cprd` function defines the tables and the count of *raw* files associated with that table in the data location. This outputted list is core to the automated loading of CPRD data, using the tables and files in each table to load all or a selection of specified CPRD GOLD files.  

To load the `patient` data into a new database, the `load_cprd` function is defined as 
```{r}
load_cprd(db_path = DB.path, 
          file_location = FILE.path, 
          tables_to_load = "Patient", 
          folder = T, 
          zip = T, 
          load_mapping = F, 
          overwrite = F)
```

## Extracting

## Maintenace and other tasks

# References
